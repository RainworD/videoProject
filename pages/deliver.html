<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>视频监控</title>
    <link rel="stylesheet" href="../source/mui/css/mui.css">
    <link rel="stylesheet" type="text/css" href="../source/Font-Awesome-3.2.1/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../source/Font-Awesome-3.2.1/css/font-awesome-ie7.min.css">
    <link rel="stylesheet" href="../source/css/imagepreview.css">
    <link rel="stylesheet" href="../source/css/init.css">
    <link rel="stylesheet" href="../source/css/public.css">
    <script src="../source/js/jquery-1.11.1.min.js"></script>
    <script src="../source/js/ajax_.js"></script>
</head>
<style type="text/css">
    body{
        background-color: #f3f3f3;
    }
</style>
<body>
    <div class="deliverBox">
        <p class="deliverBox_">
            <textarea placeholder="输入文本，请少于200字"></textarea>
        </p>
        <div class="deliverImg">
            <!-- <div class="deliverImg_">
                <img src="../source/img/0.png" data-preview-src="" data-preview-group="1" class="commonImg">
                <img src="../source/img/remove.png" alt="" class="removeBtn">
            </div>
            <div class="deliverImg_">
                <img src="../source/img/0.png" data-preview-src="" data-preview-group="1" class="commonImg">
                <img src="../source/img/remove.png" alt="" class="removeBtn">
            </div> -->
           <!--  <div class="deliverImg_ deliverImg_1 plusMoreImg" id="uploadForm">
                <a href="#picture">
                    <input id="file" type="file"  multiple="multiple"/>
                    <img src="../source/img/plus.png" alt="" class="commonImg">
                </a>
                <button id="upload" type="button">导入excel</button>
            </div> -->
            <div class="deliverImg_ deliverImg_1 plusMoreImg">
                <a href="#picture"><img src="../source/img/plus.png" alt="" class="commonImg"></a>
            </div>
        </div>
    </div>
    <div class="notice">
        <p class="topPara">知会同事&nbsp;<span>(再次点击头像可删除)</span></p>
        <div class="userIcon">
            <img src="../source/img/q.png" class="userPic">
            <img src="../source/img/q.png" class="userPic">
            <img src="../source/img/q.png" class="userPic">
            <img src="../source/img/q.png" class="userPic">
            <img src="../source/img/q.png" class="userPic">
            <img src="../source/img/q.png" class="userPic">
            <img src="../source/img/userPlus.png" class="userPlus">
        </div>
    </div>
    <div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
        <ul class="mui-table-view">
            <li class="mui-table-view-cell">
                <a href="#">拍照</a>
            </li>
            <li class="mui-table-view-cell" id="uploadForm">
                <a>相册
                </a>
                <input id="file" type="file"  multiple="multiple"/>
            </li>
        </ul>
        <ul class="mui-table-view">
            <li class="mui-table-view-cell">
                <a href="#picture"  id="cancel"><b>取消</b></a>
            </li>
        </ul>
    </div>
    <ul class="mui-table-view">
        <li class="mui-table-view-cell" style="text-align: center;color:#e74f3a;">
            <a id="upload">确认发布</a>
        </li>
    </ul>
</body>
<script type="text/javascript">
    $(".removeBtn").bind("click",function(){
        $(this).parents(".deliverImg_").remove();
    })
    $(".userPic").bind("click",function(){
        $(this).remove();
    })
    $(".plusMoreImg").bind("click",function(){
        $(".mask").addClass("show");
        $(".addPhoto").addClass("show");
    })
    $(".cancelBtn").bind("click",function(){
        $(".mask").removeClass("show");
        $(".addPhoto").removeClass("show");
    })
    $(".userPlus").bind("click",function(){
        window.location.href="workmatesList.html"
    })
</script>
<script src="../source/mui/js/mui.min.js"></script>
<script src="../source/mui/js/mui.zoom.js"></script>
<script src="../source/mui/js/mui.previewimage.js"></script>
<script>
    mui.init({
        swipeBack:true //启用右滑关闭功能
    });
    mui('body').on('shown', '.mui-popover', function(e) {
        //console.log('shown', e.detail.id);//detail为当前popover元素
    });
    mui('body').on('hidden', '.mui-popover', function(e) {
        //console.log('hidden', e.detail.id);//detail为当前popover元素
    });
    // var info = document.getElementById("info");
    mui('body').on('tap', '.mui-popover-action li>a', function() {
        var a = this,
            parent;
        //根据点击按钮，反推当前是哪个actionsheet
        for (parent = a.parentNode; parent != document.body; parent = parent.parentNode) {
            if (parent.classList.contains('mui-popover-action')) {
                break;
            }
        }
        //关闭actionsheet
        mui('#' + parent.id).popover('toggle');
        // info.innerHTML = "你刚点击了\"" + a.innerHTML + "\"按钮";
    })
    mui.previewImage();
</script>
<script>
    var type_arr=[];
    $("#file").on("change", function(e){
        type_arr=[];
        var btn=document.getElementById("cancel");
        mui.trigger(btn,'tap');
        // $("#picture").css("display","none");
        // $(".mui-backdrop").removeClass("mui-active");
        var file = e.target.files; //获取图片资源
        // console.log(file.length);
        for(var i=0; i< file.length; i++){
            var type=file[i] .type;
            type_arr.push(type);  
            // if (!file[i].type.match('image.*')) {
            //     return false;
            // }//只选取图片文件
            var reader = new FileReader();

            reader.readAsDataURL(file[i]); // 读取文件
              // 渲染文件
            reader.onload = function(arg) {
                var img='<div class="deliverImg_">'+
                            '<img src="' + arg.target.result + '" data-preview-src="" data-preview-group="1" class="commonImg">'+
                            '<img src="../source/img/remove.png" alt="" class="removeBtn">'+
                        '</div>'
            // var img = '<img class="preview" src="' + arg.target.result + '" alt="preview"/>';
                $(".deliverImg").prepend(img);
            }
        }
    });
    $("#upload").bind("click",function(){
        if(type_arr.length){
            console.log("success");
            for(var i=0;i<type_arr.length;i++){
                $.when(getImgUrl(type_arr[i])).done(function(data){
                    console.log(data);
                    if(data.state==0){
                        var data=data.data;
                        OSSAccessKeyId=data.OSSAccessKeyId;
                        Signature=data.Signature;
                        callback=data.callback;
                        key=data.key;
                        policy=data.policy;
                    }
                    var picFileList = $("#file").get(0).files;
                    // var picFileList = $("#pic")[0].files;验证是否可行
                    var formData = new FormData();
                    for(var i=0; i< picFileList.length; i++){
                        formData.append("OSSAccessKeyId",OSSAccessKeyId);
                        formData.append("Signature",Signature);
                        formData.append("callback",callback);
                        formData.append("key",key);
                        formData.append("policy",policy);
                        formData.append("file" , picFileList[i]);

                        $.ajax({
                            url: 'http://xiyou-monitor.oss-cn-hangzhou.aliyuncs.com',
                            type: 'POST',
                            cache: false,
                            data: formData,
                            processData: false,
                            contentType: false
                        }).done(function(res) {
                            if(res.state==0){
                                alert("发布成功！");
                            }
                            else{
                                alert("发布失败！");
                            }
                        }).fail(function(res) {
                        });
                    }
                    // formData.append('file', $('#file')[0].files[0]);
                })
            }
        }
    })
    function deliverActivity(){

    }
</script>
</html>
